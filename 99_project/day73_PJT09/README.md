# pjt 09

## ğŸ“œì†Œê°



```
ì´ì „ì— ë°°ìš´ ìë°”ìŠ¤í¬ë¦½íŠ¸ì˜ ì¢‹ì•„ìš”ì™€ íŒ”ë¡œìš°ë¥¼ ë‹¤ì‹œê³µë¶€í•˜ë©´ì„œ ì§„í–‰í•˜ì˜€ê³  ì¸í”¼ë‹ˆíŠ¸ ìŠ¤í¬ë¡¤ì„ í•˜ë©´ì„œ ë§ì€ë¶€ë¶„ì—ì„œ ë§‰í˜”ë‹¤.
ì¼ë‹¨ êµ¬í˜„ ê¹Œì§€ëŠ” ì™„ë£Œí–ˆëŠ”ë° ê·¸ë‹¤ìŒì— ë¶€íŠ¸ìŠ¤íŠ¸ë©ìœ¼ë¡œ ì „ì²´ì ìœ¼ë¡œ ê¾¸ë¯¸ë©´ì„œ ì¹´ë“œë¡œ í‘œí˜„í•˜ì—¬ 2ê°œì”© 5ì¤„ ë‚˜ì˜¤ê³  ê·¸ë‹¤ìŒì— ì¸í”¼ë‹ˆíŠ¸ ìŠ¤í¬ë¡¤ì„ êµ¬í˜„í• ë ¤ê³  í–ˆëŠ”ë° ì˜ì•ˆë˜ì—ˆë‹¤. ê·¸í›„ì— ì›ìƒë³µêµ¬ í›„ì— ì¸í”¼ë‹ˆíŠ¸ ìŠ¤í¬ë¡¤ì„ ì§„í–‰í•˜ë ¤ê³  í•˜ëŠ”ë° ì‘ë™ì´ ì•ˆë˜ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•˜ì—¬ ì• ë¥¼ ë¨¹ì—ˆë‹¤.
ì•„ì§ê¹Œì§€ ë§ì´ ë¶€ì¡±í•´ì„œ ê³µë¶€ê°€ ë§ì´ í•„ìš”í•˜ë‹¤....í”„ë¡ íŠ¸ê°€ ì¬ë¯¸ìˆëŠ” í•œë° ì–´ë µê¸°ë„ í•´ì„œ ì–´ì§€ëŸ½ë‹¤
```

```txt
 viewì—ì„œ ë°ì´í„°ë¥¼ ê°€ê³µí•˜ê³  htmlì—ì„œ ì‚¬ìš©í•˜ëŠ”ë° ë¨¸ë¦¿ ì†ì—ì„œ ìƒê°í•œ ëŒ€ë¡œ íœ™íœ™ ê·¸ë¦¬ê¸°ì—ëŠ” ì—°ìŠµì´ ë§ì´ ë¶€ì¡±í–ˆë˜ ê²ƒ ê°™ë‹¤. ì•ì˜ ì‹¤ìŠµ íŒŒì¼ë“¤ì„ ì°¸ê³ í•˜ë©´ì„œ ì™„ì„±í•  ìˆ˜ ìˆì—ˆê³  íŠ¹íˆ ì–´ë–¤ ê¸°ëŠ¥ì„ ìƒˆë¡œ ì™„ì„±í•˜ëŠ” ë° ìˆì–´ì„œ ê³µì‹ ë¬¸ì„œë¥¼ ì›í™œíˆ ì‚¬ìš©í•˜ê³  ê²€ìƒ‰ì„ ì˜ í™œìš©í•˜ëŠ” ê²Œ ì•ìœ¼ë¡œ ê´€ê±´ì¸ ê²ƒ ê°™ë‹¤. ì¶”ì²œ ì˜í™”ë¥¼ ì™„ì„±í•˜ëŠ” ë° ìˆì–´ì„œ view ì—ì„œ í•¨ìˆ˜ë¥¼ êµ¬ì„±í•  ë•Œ ì¿¼ë¦¬ì— ëŒ€í•œ ì• ë§¤í•œ ì§€ì‹ìœ¼ë¡œ ë” í—¤ë§¸ë˜ ê²ƒ ê°™ë‹¤. ê³µì‹ ë¬¸ì„œë¥¼ ë”ë”ìš± ì‹ ë´‰í•´ì•¼ê² ë‹¤.
```



## âš™êµ¬í˜„ê³¼ì •

#### ì„œìˆ 

```
êµ¬í˜„ê³¼ì •
(1) ìë°”ìŠ¤í¬ë¦½íŠ¸ì™€ axiosë¥¼ ì‚¬ìš©í•´ì„œ ìœ ì € íŒ”ë¡œìš°ë¥¼ êµ¬í˜„
(2) ìœ„ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì¢‹ì•„ìš” ë²„íŠ¼ êµ¬í˜„
(3) ì˜í™” ë°ì´í„°ë¥¼ loaddata ë¥¼ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë¥¼ ë°›ê¸°
    1) movies/index.html ì‘ì„± - views.py ì‘ì„±í›„ì— ì‘ì„±
       ì¸í”¼ë‹ˆíŠ¸ ìŠ¤í¬ë¡¤ ì¶”ê°€
    2) movies/detail.html ì‘ì„± - views.py ì‘ì„± í›„ì— ì‘ì„±
       í•„ìš”í•œ ë°ì´í„° ì¶”ê°€

(4)

í•™ìŠµë‚´ìš©
javascriptì™€ axiosë¥¼ ì‚¬ìš©í•´ì„œ ì „ì²´ì ì¸ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“œëŠ” ê³¼ì •ì´ì˜€ê³  ë³µìŠµ ê°œë…ë„ ìˆì—ˆìœ¼ë©° ì˜¤ëŠ˜ ìœ íŠœë¸Œì—ì„œ ì•Œë ¤ì£¼ì‹  ë‚´ìš©ìœ¼ë¡œ ì ìš©í•´ ë³´ì•˜ë‹¤.
```

#### movies/views.py

```python
# movies/views.py

from django.shortcuts import get_object_or_404, render
from django.views.decorators.http import require_safe
from .models import Movie, Genre
from django.core.paginator import Paginator
from django.core import serializers
from django.http import HttpResponse
from datetime import date

# Create your views here.
@require_safe    
def index(request):
    genres = Genre.objects.all()
    movies = Movie.objects.order_by('-pk')        
    paginator = Paginator(movies,10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    if request.headers.get('x-requested-with') =='XMLHttpRequest':
        data = serializers.serialize('json', page_obj)
        return HttpResponse(data, content_type='application/json')
    context = {
        'genre_data':serializers.serialize('json', genres),
        'movies':page_obj,
    }    
    return render(request, 'movies/index.html', context)

@require_safe
def detail(request, movie_pk):
    movie = get_object_or_404(Movie, pk=movie_pk)    
    context = {
        'movie':movie
    }
    return render(request, 'movies/detail.html', context)
```



#### movies/index.html

```html
<!-- movies/index.html -->

{% extends 'base.html' %}
{% block content %}

<h1 class="d-flex justify-content-center">Movies</h1>
  <div class='movielist'>
    <div class="row row-cols-2">
      {% for movie in movies %}
      <div id="movie"> 
      <div class="col">   
        <div class="card">
          <img src="{{movie.poster_path}}" class="card-img-top" alt="{{movie.title}}" width="150">
          <div class="card-body">
            <h5 class="card-title">{{ movie.title }}</h5>
            <hr>
            {% for genre in movie.genres.all %} 
            <span class="card-title">{{ genre.name }}</span>
            {% endfor %}
            <hr>
            <p class="card-text" style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">{{ movie.overview }}</p>
            <a href="{% url 'movies:detail' movie.pk %}">[DETAIL]</a>
          </div>
        </div>
        </div>
      </div>
    {% endfor %}
    </div>
  </div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  let pageNum = 2
  document.addEventListener('scroll', (event) => {
    // console.log(event)
    const { scrollHeight, scrollTop, clientHeight } = document.documentElement
    // console.log(scrollHeight, scrollTop, clientHeight)    
    if (scrollHeight - Math.round(scrollTop) === clientHeight) {
      axios({
      method: 'get',
      url: `/movies/?page=${pageNum}`,
      headers: {'x-requested-with': 'XMLHttpRequest'}
    })
      .then((response) => {
        const movies = response.data       
        // console.log(movies)
        movies.forEach((movie) => {
            const movieList = document.querySelector('.row-cols-2')
            const movieDiv = document.createElement('div')
        // console.log(movie)        
        const m = "{{ genre_data|escapejs }}"        
        const genre_pk = JSON.parse(m)
        const genrenames = movie.fields.genres.reduce((pre,el) => {      
          const gname = genre_pk.filter(e=>e.pk==el)[0].fields.name
          return pre + `<span class="card-title">${ gname } </span>`
        },'')        
        // console.log(movie)
        const movieHTML = 
         `
          <div class="col">   
            <div class="card">
              <img src="${movie.fields.poster_path}" class="card-img-top" alt="${movie.fields.title}" width="150">
              <div class="card-body">
                <h5 class="card-title">${ movie.fields.title }</h5>
                <hr>                
                ${genrenames}
                <hr>
                <p class="card-text" style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${ movie.fields.overview }</p>
                <a href="${movie.pk}/">[DETAIL]</a>
              </div>
            </div>
          </div>
          `
          // console.log(movieHTML)
          movieDiv.innerHTML = movieHTML
          // console.log(movieDiv)
          movieList.appendChild(movieDiv)
          // console.log(movieHTML)
        })    
        pageNum += 1
      })
    }
    // console.log(clientHeight)
    // console.log(scrollHeight - Math.round(scrollTop))
    // console.log('----------------------------------')
  })    
</script>

{% endblock %}
```



#### movies/detail.html

```django
<!-- movies/detail.html -->

{% extends 'base.html' %}

{% block content %}
<h1>[DETAIL]</h1>
<hr>
  <p>Title: {{ movie.title }}</p>
  <hr>
  <img src="{{ movie.poster_path }}" alt="movie.title">  
  <p>Release: {{ movie.release_date }}</p>
  <hr>
  <p>Genres:
    {% for genre in movie.genres.all %}
      <span class="card-title">{{ genre.name }}</span>
    {% endfor %}
  </p>
  
  <hr>
  <p>Popular: {{ movie.popularity }}</p>
  <hr>
  <p>All_vote : {{ movie.vote_count }}</p>
  <hr>
  <p>Age_vote: {{ movie.vote_average }}</p>
  <hr>
  <p>Overview</p>
  <p>{{ movie.overview }}</p>  
  <hr>
<a href="{% url 'movies:index' %}">[BACK]</a>
{% endblock %}
```

```txt
ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ í•˜ë©° idì™€ classë¥¼ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì ì ˆíˆ ì‚¬ìš©í•´ì„œ ë‹¤ë¥¸ eventë‚˜ methodë¥¼ í†µí•´ í™œìš©í•˜ëŠ” ë²•ì„ ì£¼ë¡œ ìµíŒ ê²ƒ ê°™ë‹¤. ì´ì „ì—ëŠ” í•˜ë‚˜ì˜ listë‚˜ dictionary ì•ˆì— ìˆëŠ” ê²ƒì´ ëª…ì‹œì ìœ¼ë¡œ ëª¨ë‘ ë³´ì˜€ê³  ì§ì ‘ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í–ˆë‹¤ë©´ axiosë¥¼ ì‚¬ìš©í•˜ê³  htmlë¡œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ë©´ì„œ ìš°ë¦¬ê°€ êµ¬ì„±í•˜ì§€ ì•Šì€ ë°ì´í„°ì— ëŒ€í•œ ì ‘ê·¼ì´ ì •ë§ ì–´ë ¤ì› ë‹¤. console ì°½ì—ì„œ ì¼ì¼ì´ logë¥¼ ì°ì–´ê°€ë©° ê¹¨ë‹¬ì•˜ë‹¤. div ë‚˜ inputìœ¼ë¡œ ë°›ì€ ë°ì´í„°ë¥¼ scriptì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë¶ˆëŸ¬ì˜¤ëŠ” ë²• ë§ì€ eventë“¤ê³¼ ê³µì‹ ë¬¸ì„œ ì—†ì´ëŠ” í”„ë¡œì íŠ¸ë¥¼ í•´ë‚´ê¸°ê°€ ì–´ë ¤ì› ë‹¤.

profile - followêµ¬í˜„
button clickìœ¼ë¡œ ì´ë²¤íŠ¸ê°€ ë°œìƒ
follow switch 
ë³€ê²½ëœ button innertextê³¼ follower ìˆ˜ë¥¼ ë³´ì—¬ì£¼ì—ˆë‹¤.

ì¶”ì²œ ì˜í™”
2019ë…„ 1ì›” 1ì¼ ì´í›„ë¶€í„° ì˜¤ëŠ˜ê¹Œì§€ ê°œë´‰ëœ ì˜í™” ì¤‘ì—ì„œ í‰ì ì´ ë†’ì€ ì˜í™”ë¥¼ filterë¡œ êµ¬í•´ì„œ QuerySetì˜ 0ë²ˆì§¸ ê°ì²´ë¥¼ ë„ì¶œ
ê°ì²´ê°€ ê°’ì´ ìˆê³  movielistì— ì—†ìœ¼ë©´ ë„£ì–´ì„œ htmlë¡œ ë³´ë‚¸ë‹¤.

ì¤‘ë³µì´ ì—†ê³  ì¥ë¥´ì—ì„œ í‰ì ì´ ê°€ì¥ ë†’ì€ ì˜í™”ë¥¼ í•˜ë‚˜ì”© ë³´ì—¬ì¤€ë‹¤.
```



#### accounts/profiles-script

```html
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const forms = document.querySelectorAll('.followform')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
    forms.forEach(form => {
      form.addEventListener('submit', function(event) {
        event.preventDefault()
        const profileId = event.target.dataset.profileId
        axios({
          method:'post',
          url: `http://127.0.0.1:8000/accounts/${profileId}/follow/`,
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
        .then(response => {
          const follow = response.data.follow
          const followCount = response.data.followCount
          const followBtn = document.querySelector(`#follow-${profileId}`)
          const followCountNum = document.querySelector(`#follow-count-${profileId}`)
          followBtn.innerText = follow ? 'ì–¸íŒ”ë¡œìš°' : 'íŒ”ë¡œìš°'
          followBtn.style.color = follow ? 'red' : 'blue'
          followCountNum.innerText = followCount

        })
      })
    })
  </script>
```



#### accounts/views-follow

```python
@require_POST
def follow(request, user_pk):
    if request.user.is_authenticated:
        person = get_object_or_404(get_user_model(), pk=user_pk)
        user = request.user
        if person != user:
            if person.followers.filter(pk=user.pk).exists():
                person.followers.remove(user)
                follow = False
            else:
                follow = True
                person.followers.add(user)
            context = {
                'follow':follow,
                'followCount':person.followers.count(),
                'person.username':person.username,
            }
        return JsonResponse(context)
    return redirect('accounts:login')
```

#### movies/views-recommended

```python
@require_safe
def recommended(request):
    startdate=date(2019,1,1)
    genres = Genre.objects.all()
    movielist = []
    for genre in genres:
        movie=Movie.objects.filter(release_date__range=(startdate, date.today())).filter(genres=genre.pk).order_by("vote_average")[:1]
        if movie and movie[0]not in movielist:
            movielist.append(movie[0])
    context = {
        'movies':movielist,
    }
    return render(request, 'movies/recommended.html', context)
```

